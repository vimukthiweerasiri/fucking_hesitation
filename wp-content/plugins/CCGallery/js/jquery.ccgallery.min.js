/* CCGallery - HTML5 Multimedia Gallery - 4.1.1
 * Copyright 2012, Nilok Bose  
 * http://codecanyon.net/user/cosmocoder
*/


jQuery(function(d){var q=d("#ccgallery"),m=d("#thumbGallery"),n=d("#thumbGallery").find("ul"),l=d("#itemList"),c=d("#coverflowGallery"),f=d("#coverContainer"),k=navigator.appName.toLowerCase().indexOf("microsoft")!=-1,a=k&&parseFloat(navigator.appVersion.split("MSIE")[1],10)<9&&IE7.recalc?true:false,e={id:galleryParams.id,mobile:false,action:"ccgallery_xml"},g=q.data("autoplay")===true?true:false,i=q.data("loop")===true?true:false,j=q.data("storeVolume")===true?true:false,p=q.data("newWindowLinks")===true?true:false;if(q.data("mobile")===true){d.ajax({type:"GET",url:galleryParams.pluginUrl+"includes/mobile.php",dataType:"text",success:function(r){if(r==="true"){e.mobile=true}h()}})}else{h()}function h(){d.ajax({type:"GET",url:galleryParams.ajaxUrl,dataType:"xml",data:e,success:function(r){o(d(r))}})}function o(D){var r=D.find("file"),w=r.find("cover"),v=r.find("thumb"),u=r.find("title"),z=r.find("description"),C=r.length,t=0;var y="",F="",E="";for(var x=0;x<C;x++){var B=r.eq(x).find("category"),A='{"category": false}';if(B.length!==0){A="{";B.each(function(){A+='"'+d(this).text()+'": true,'});A=A.substr(0,A.length-1);A+="}"}y+='<li data-id="'+(x+1)+'" data-type="'+r.eq(x).attr("type")+"\" data-categories='"+A+"'>";y+='<img class="thumb" src="'+v.eq(x).text()+'" alt="" />';y+='<div class="details">';y+="<h2>"+u.eq(x).text()+"</h2>";y+='<p class="description">'+z.eq(x).text()+"</p>";y+="</div>";y+="</li>";F+='<img src="'+w.eq(x).text()+'" alt="" />';E+='<li data-id="'+(x+1)+'" data-type="'+r.eq(x).attr("type")+"\" data-categories='"+A+"'>";E+='<span class="details">';E+="<h2>"+u.eq(x).text()+"</h2>";E+='<p class="description">'+z.eq(x).text()+"</p>";E+="</span>";E+="</li>"}n.html(y);f.html(F);l.html(E);if(a){l.on("mouseleave click","li",function(G){d(this).removeClass("ie7_class7")});n.on("mouseleave","li",function(G){d(this).removeClass("ie7_class4")})}var s;if(d("#gocoverflow").hasClass("active")){s="coverflow"}else{s="thumbnails";if(k){q.find("section").css({position:"absolute",top:"0",left:"0"});c.css({display:"block",opacity:"0"})}}q.find("img").load(function(){t++;if(t===2*C){q.css({height:"auto",background:"none"});if(s==="coverflow"){f.parent().fadeIn(600)}else{m.fadeIn(600);if(k){q.find("section").css("position","static");c.css({display:"none",opacity:"1"})}}b(C,r)}})}function b(C,y){var X=n.clone(),Q=l.clone(),T=100;if(k&&parseFloat(navigator.appVersion.split("MSIE")[1],10)==9){var E=d('<div id="olfix"/>').insertAfter(l)}q.find("menu").on("click","a.navbuttons",function(){var aG=d(this),aC=aG.index(),aH=d("section.displayStyle"),aD=aG.data("type"),aE=aG.data("category");aG.addClass("active").siblings().removeClass("active");if(aG.parent().is("#sortButtons")){var aB,aF;if(aD){if(aD==="all"){aB=X.find("li");aF=Q.find("li")}else{aB=X.find("li[data-type="+aD+"]");aF=Q.find("li[data-type="+aD+"]")}}else{if(aE){aB=X.find("li").filter(function(){if(aE in d(this).data("categories")){return true}});aF=Q.find("li").filter(function(){if(aE in d(this).data("categories")){return true}})}}n.quicksand(aB,{duration:T,adjustHeight:"auto",useScaling:false},function(){n.css("height","auto");if(a){IE7.recalc()}});l.quicksand(aF,{duration:T,adjustHeight:"auto",useScaling:false},function(){l.css("height","auto");aa();if(a){IE7.recalc()}if(E){E[0].innerHTML=" "}})}else{if(aH.eq(aC).is(":visible")){return false}else{aH.filter(":visible").fadeOut(600,function(){aH.eq(aC).fadeIn(600)})}}});d("#sortButtons").find("a.active").not('[data-type="all"]').trigger("click");T=800;var aq;n.on("click","img.thumb",function(){var aF=d(this).parent(),aB=aF.data("id")-1,aD=aF.data("type"),aE=y.eq(aB).find("link").text(),aC=y.eq(aB).find("source"),aG="thumb";aq=n.find("img.thumb").index(this);if(aE){if(p){window.open(aE,"_blank")}else{window.location.href=aE}}else{an(aG,aD,aC,aF.find("h2")[0].innerHTML,aF.find("p")[0].innerHTML)}});var ay=f.find("img"),ab=d('<div class="cwrapper"/>').appendTo(f).hide(),W=d('<canvas class="fade"/>').appendTo(f),M=d('<p id="coverTitle"/>').appendTo(f).css("z-index",2*C),s=f.width(),v=0,R,at=q.data("coverStartItem"),x=q.data("coverflowFade")===false?false:true,D=q.data("noReflection")===true?true:false,u=q.data("background"),af=at!==undefined?parseInt(at)-1:C%2===0?C/2-1:(C+1)/2-1,ax=u?getRGB(u):getRGB(d("body").css("background-color")),al,B=document.createElement("canvas").getContext?true:false,z=Modernizr.csstransforms3d,ac=d(window);if(c.is(":hidden")){c.css({display:"block",visibility:"hidden"});s=f.width();c.css({display:"none",visibility:"visible"})}for(var av=0;av<C;av++){if(v<ay.eq(av)[0].height){v=ay.eq(av)[0].height;R=v}}if(B){v=D?v:(1.5*v)|0;f.height(v)}else{f.height(v+20)}var U=[],F=[],aw=[],L=[],w=[],H=[],N=[],ad=[],ao=ay[af].width,ap=[],Z=[],A=[];z&&f.addClass("css3d");function au(){Z=[];A=[];if(B){var aD=C,aI,aH,aF,aG,aB,aE,aC;while(aD--){aB=l.find("li").eq(aD).data("id")-1;aw[aD]=ay[aB].width;L[aD]=ay[aB].height;U[aD]=d('<canvas class="cover"/>').data("index",aD);Z[aD]=U[aD][0];F[aD]=U[aD][0].getContext("2d");U[aD][0].width=aw[aD];U[aD][0].height=D?L[aD]:(1.5*L[aD])|0;w[aD]=new Plane(aw[aD],U[aD][0].height,600,F[aD],"#666",ax,ay[aB],D);if(aD<af){aI=aD;if(z){w[aD].render();aH=s/2-ao/2-U[aD][0].width+(aD-af+1)*60;aE="translate3d("+aH+"px,0,-100px) rotateY(60deg)"}else{w[aD].rotation.y=Math.PI/4;w[aD].position.z=100;w[aD].render();H[aD]=w[aD].maxwidth;N[aD]=w[aD].maxoffset;aF=H[aD];aH=s/2-U[aD][0].width/2-ao/2-H[aD]/2+(aD-af+1)*40+N[aD]/2;aG=s/2-aF/2-ao/2-aF/2+(aD-af+1)*40}}else{if(aD>af){aI=C-2-aD;if(z){w[aD].render();aH=s/2+ao/2+(aD-af-1)*60;aE="translate3d("+aH+"px,0,-100px) rotateY(-60deg)"}else{w[aD].rotation.y=-Math.PI/4;w[aD].position.z=100;w[aD].render();H[aD]=w[aD].maxwidth;N[aD]=w[aD].maxoffset;aF=H[aD];aH=s/2-U[aD][0].width/2+ao/2+H[aD]/2+(aD-af-1)*40-N[aD]/2;aG=s/2+ao/2+(aD-af-1)*40}}else{if(aD===af){aI=aD;if(z){w[aD].render();aE="translate3d("+(s/2-ao/2)+"px, 0, 0) rotateY(0deg)"}else{w[aD].rotation.y=Math.PI/4;w[aD].position.z=100;w[aD].render();H[aD]=w[aD].maxwidth;N[aD]=w[aD].maxoffset;w[aD].rotation.y=0;w[aD].position.z=0;w[aD].render()}aH=s/2-ao/2;aF=ao;aG=s/2-aF/2}}}ad[aD]=d('<a class="coverclick"/>').data("index",aD);A[aD]=ad[aD][0];if(z){aC={"-moz-transform":aE,"-webkit-transform":aE,"-o-transform":aE,"-ms-transform":aE,transform:aE};U[aD].css({zIndex:aI,top:R-L[aD],bottom:"auto"}).css(aC);ad[aD].css({width:aw[aD],height:U[aD][0].height,top:R-L[aD],bottom:"auto",zIndex:C+2+aI,}).css(aC)}else{U[aD].css({zIndex:aI,left:aH,top:R-L[aD],bottom:"auto"});ap[aD]={posZ:w[aD].position.z,rotY:w[aD].rotation.y,cover:w[aD]};ad[aD].css({left:aG,top:R-L[aD],bottom:"auto",zIndex:C+2+aI,width:aF,height:U[aD][0].height})}}ab.append(Z);f.append(A)}else{var aD=C,aH,aI,aB;while(aD--){aB=l.find("li").eq(aD).data("id")-1;aw[aD]=ay.eq(aB)[0].width;L[aD]=ay.eq(aB)[0].height;U[aD]=d('<div class="cover"/>').data("index",aD).append(ay.eq(aB).clone());Z[aD]=U[aD][0];H[aD]=Math.round(0.7*aw[aD]);if(aD<af){aH=s/2-ao/2-H[aD]+(aD-af)*40;aI=aD;U[aD].width(H[aD]);U[aD].height(Math.round(H[aD]*L[aD]/aw[aD]))}else{if(aD>af){aH=s/2+ao/2+(aD-af)*40;aI=C-1-aD;U[aD].width(H[aD]);U[aD].height(Math.round(H[aD]*L[aD]/aw[aD]))}else{if(aD===af){aH=s/2-ao/2;aI=aD;U[aD].width(aw[aD]);U[aD].height(L[aD])}}}U[aD].css({left:aH,zIndex:aI});ad[aD]=d('<a class="coverclick"/>').data("index",aD);A[aD]=ad[aD][0];ad[aD].css({left:aH,bottom:0,top:"auto",zIndex:C+2+aI,width:U[aD].width(),height:U[aD].height()})}ab.append(Z).height(v);f.append(A);M.css("bottom","0px")}}au();function t(){if(B&&x){W.css({position:"absolute",bottom:"0",left:"0",zIndex:C+1});W[0].width=s;W[0].height=v;var aC=W[0].getContext("2d"),aB=aC.createLinearGradient(0,0,s,0);aB.addColorStop(0,"rgba("+ax.r+","+ax.g+","+ax.b+", 1.0)");aB.addColorStop(0.35,"rgba("+ax.r+","+ax.g+","+ax.b+", 0.0)");aB.addColorStop(0.65,"rgba("+ax.r+","+ax.g+","+ax.b+", 0.0)");aB.addColorStop(1,"rgba("+ax.r+","+ax.g+","+ax.b+", 1.0)");aC.fillStyle=aB;aC.rect(0,0,s,v);aC.fill()}}t();ay.hide();ab.fadeIn(600);al=l.find("li").eq(af).addClass("active").data("id");ad[af].addClass("active");M[0].innerHTML=y.eq(af).find("title").text();var ae=d("#scrollbar-track"),az=ae.find(".ui-slider-handle"),P=az.wrap('<div class="ui-handle-helper-parent"/>').parent();ae.slider({animate:true,max:C-1,min:0,value:af,slide:function(aB,aC){Y(aC.value)}});P.width(ae.width()-az.width());d("#next").click(function(){ae.slider("value",af+1);Y(af+1)});d("#prev").click(function(){ae.slider("value",af-1);Y(af-1)});d(document).keydown(function(aC){var aB=aC.keyCode||aC.charCode;if(aB===39){if(am.is(":visible")||m.is(":visible")){return}ae.slider("value",af+1);Y(af+1)}else{if(aB===37){if(am.is(":visible")||m.is(":visible")){return}ae.slider("value",af-1);Y(af-1)}else{if(aB===13){if(am.is(":visible")||m.is(":visible")){return}l.find("li.active").trigger("click")}else{if(aB===27){S.trigger("click")}}}}});f.on("click","a.coverclick",function(){var aC=d(this),aB=aC.data("index");if(aC.hasClass("active")){l.find("li").eq(aB).trigger("click")}else{if(aB!==af){ae.slider("value",aB);Y(aB)}}});f.mousewheel(function(aB,aC){aC=-Math.round(aC);if(aC!==0){ae.slider("value",af+aC);Y(af+aC)}});if("ontouchstart" in window){var ag,V;f.on("touchstart",function(aB){var aC=aB.originalEvent.targetTouches[0];ag=aC.pageX}).on("touchmove",function(aB){aB.preventDefault();V=aB.originalEvent.targetTouches[0].pageX}).on("touchend",function(){if(!V){return}var aD=V-ag,aB=Math.round(aD/100),aC=af-aB;if(af-aB<0){aC=0}else{if(af-aB>=C){aC=C-1}}ae.slider("value",aC);Y(aC);V=null})}var G=false;f.hover(function(){G=true},function(){G=false});d(window).mousewheel(function(){if(G){return false}});l.on("click","li",function(){var aE=d(this),aC=aE.index(),aB=aE.data("id")-1,aF="coverflow";if(aE.hasClass("active")){var aD=y.eq(aB).find("link").text();if(aD){if(p){window.open(aD,"_blank")}else{window.location.href=aD}}else{an(aF,aE.data("type"),y.eq(aB).find("source"),aE.find("h2")[0].innerHTML,aE.find("p")[0].innerHTML)}}else{if(aC!==af){aE.addClass("active").siblings().removeClass("active");ae.slider("value",aC);Y(aC)}}});function aa(){var aC=l.find("li"),aB=aC.filter("[data-id="+al+"]");if(aB.length===1){aC.removeClass("active");aB.addClass("active")}else{if(aB.length===0){aB=aC.eq(0);aB.addClass("active");al=aB.data("id")}}ab.empty();f.find("a.coverclick").remove();af=aC.index(aB);C=aC.length;ao=ay.eq(al-1)[0].width;au();W.css("z-index",C+1);ad[af].addClass("active");ae.slider("option","max",C-1);ae.slider("option","value",af);M[0].innerHTML=y.eq(al-1).find("title").text()}ac.resize(function(){if(f.is(":hidden")){c.css({position:"absolute",top:0,left:0,display:"block",opacity:0});s=f.width();c.css({position:"static",display:"none",opacity:1})}else{s=f.width()}ab.empty();f.find("a.coverclick").remove();ao=ay.eq(al-1)[0].width;au();t();ad[af].addClass("active")});d.easing.easeOutQuint=function(aC,aD,aB,aF,aE){return aF*((aD=aD/aE-1)*aD*aD*aD*aD+1)+aB};function Y(aC){if(aC>=0&&aC<C){var aF=C;al=l.find("li").removeClass("active").eq(aC).addClass("active").data("id");ad[af].removeClass("active");ad[aC].addClass("active");M[0].innerHTML=y.eq(al-1).find("title").text();if(B){d.fx.interval=25;var aJ,aD,aG,aI,aL,aE,aB,aK;while(aF--){if(aF<aC){aJ=aF;if(z){aD=s/2-aw[aC]/2-U[aF][0].width+(aF-aC+1)*60;aB="translate3d("+aD+"px,0,-100px) rotateY(60deg)"}else{aD=s/2-U[aF][0].width/2-aw[aC]/2-H[aF]/2+(aF-aC+1)*40+N[aF]/2;aG=H[aF];aI=s/2-aG/2-aw[aC]/2-aG/2+(aF-aC+1)*40;aL=100;aE=Math.PI/4}}else{if(aF>aC){aJ=C-1-aF;if(z){aD=s/2+aw[aC]/2+(aF-aC-1)*60;aB="translate3d("+aD+"px,0,-100px) rotateY(-60deg)"}else{aD=s/2-U[aF][0].width/2+aw[aC]/2+H[aF]/2+(aF-aC-1)*40-N[aF]/2;aG=H[aF];aI=s/2-aG/2+aw[aC]/2+aG/2+(aF-aC-1)*40;aL=100;aE=-Math.PI/4}}else{if(aF===aC){aJ=C;aD=s/2-aw[aC]/2;aG=aw[aC];aI=s/2-aG/2;aL=0;aE=0;aB="translate3d("+aD+"px,0,0) rotateY(0deg)"}}}U[aF].css("z-index",aJ);if(z){aK={"-moz-transform":aB,"-webkit-transform":aB,"-o-transform":aB,"-ms-transform":aB,transform:aB};U[aF].css(aK);ad[aF].css({zIndex:C+2+aJ}).css(aK)}else{ad[aF].css({zIndex:C+2+aJ,width:aG,left:aI});U[aF].stop(true,true).animate({left:aD},1200,"easeOutQuint");d(ap[aF]).stop();if(aF===af||aF===aC){ap[aF]={posZ:w[aF].position.z,rotY:w[aF].rotation.y,cover:w[aF]};d(ap[aF]).animate({posZ:aL,rotY:aE},{duration:1200,easing:"easeOutQuint",step:function(aN,aM){if(aM.prop==="posZ"){this.cover.position.z=aN}else{this.cover.rotation.y=aN;this.cover.render()}}})}else{if(w[aF].position.z!==aL||w[aF].rotation.y!==aE){w[aF].position.z=aL;w[aF].rotation.y=aE;w[aF].render()}}}}}else{var aJ,aD,aG,aH;while(aF--){if(aF<aC){aD=s/2-aw[aC]/2-H[aF]+(aF-aC)*40;aJ=aF;aG=H[aF];aH=Math.round(H[aF]*L[aF]/aw[aF])}else{if(aF>aC){aD=s/2+aw[aC]/2+(aF-aC)*40;aJ=C-1-aF;aG=H[aF];aH=Math.round(H[aF]*L[aF]/aw[aF])}else{if(aF===aC){aD=s/2-aw[aC]/2;aJ=C;aG=aw[aF];aH=L[aF]}}}U[aF].css("zIndex",aJ);ad[aF].css({zIndex:C+2+aJ,width:aG,height:aH,left:aD});U[aF].stop(true,true).animate({left:aD,width:aG,height:aH},600)}}af=aC}d(ap).promise().done(function(){d.fx.interval=16})}var r=d('<div id="mask"/>').appendTo("body"),I=d('<div id="overlayLoader"/>').appendTo("body"),am=d('<div id="overlay"/>').appendTo("body"),K=d('<div id="overlayContent"/>').appendTo(am),S=d('<a id="close"/>').appendTo(am),ah=d('<a id="prev-item"/>').appendTo(am),ar=d('<a id="next-item"/>').appendTo(am),aj,ai;K.html('<div class="details"><h2></h2><p></p></div>');var aA=K.find("h2"),O=K.find("p");function an(aG,aC,aB,aF,aD){d.data(am[0],"mode",aG);aA[0].innerHTML=aF;O[0].innerHTML=aD;var aE=ac.scrollTop()+ac.height()/2;r.css("height",d(document).height()).fadeIn(400,function(){I.css("top",aE).show();if(aC==="photo"){if(k){am.css({visibility:"hidden",display:"block"});K.css({visibility:"hidden",display:"block"})}var aJ=d('<img src="'+aB.text()+'" alt="" />').appendTo(K);aJ[0].onload=function(){J(aJ[0]);if(k){am.css({visibility:"visible",display:"none"});K.css({visibility:"visible",display:"none"})}ak(aJ[0].width,aJ[0].height,aE)}}else{if(aC==="audio"){var aL="<audio controls>",aS="<audio controls";for(var aM=0,aO=aB.length;aM<aO;aM++){var aK=aB.eq(aM).text(),aU=aK.split(".").pop();if(aU==="ogg"){aL+='<source type="audio/ogg" src="'+aK+'" />'}else{if(aU==="mp3"){aL+='<source type="audio/mpeg" src="'+aK+'" />';aS+='type="audio/mpeg" src="'+aK+'"></audio>'}}}aL+="</audio>";if(navigator.userAgent.match(/webkit/gi)!==null&&navigator.userAgent.match(/chrome/gi)===null){K.append(aS)}else{K.append(innerShiv(aL))}if(ac.width()<=480){ak(ac.width()-80,30,aE)}else{ak(400,30,aE)}}else{if(aC==="video"){var aR=600,aP=338;if(ac.width()<=680){aR=ac.width()-80;aP=aR*(338/600)}if(aB.eq(0).text().indexOf("youtube")!==-1){var aT=aB.eq(0).text().split("v=")[1],aQ=g?"&autoplay=1":"",aI='<iframe width="'+aR+'" height="'+aP+'" src="http://www.youtube.com/embed/'+aT+"?hd=1&rel=0"+aQ+'" frameborder="0" allowfullscreen></iframe>';K.append(aI)}else{if(aB.eq(0).text().indexOf("vimeo")!==-1){var aT=aB.eq(0).text().split("/").pop(),aH=g?"&autoplay=1":"",aI='<iframe src="http://player.vimeo.com/video/'+aT+"?"+aH+'" width="'+aR+'" height="'+aP+'" frameborder="0" webkitAllowFullScreen allowFullScreen></iframe>';K.append(aI)}else{var aI='<video controls width="'+aR+'" height="'+aP+'">',aN='<video controls width="'+aR+'" height="'+aP+'"';for(var aM=0,aO=aB.length;aM<aO;aM++){var aK=aB.eq(aM).text(),aU=aK.split(".").pop();if(aU==="mp4"){aI+='<source type="video/mp4" src="'+aK+'" />';aN+='type="video/mp4" src="'+aK+'"></video>'}else{if(aU==="webm"){aI+='<source type="video/webm" src="'+aK+'" />'}else{if(aU==="ogv"){aI+='<source type="video/ogg" src="'+aK+'" />'}}}}aI+="</video>";if(navigator.userAgent.match(/webkit/gi)!==null&&navigator.userAgent.match(/chrome/gi)===null){K.append(aN)}else{K.append(innerShiv(aI))}}}ak(aR,aP,aE)}}}})}function ak(aC,aG,aH){am.css({display:"block",visibility:"hidden",width:aC});K.show();var aB=am.find("div.details").height()+20,aF=-(aG+aB+40)/2,aE=-(aC+40)/2,aI=d.data(am[0],"mode"),aD=aI==="coverflow"?af:aq;K.hide();if(C===1){ah.hide();ar.hide()}else{if(aD===0){ah.hide();ar.show()}else{if(aD===C-1){ah.show();ar.hide()}else{ah.show();ar.show()}}}I.hide();am.css({display:"none",visibility:"visible",height:aG+aB,top:aH,marginTop:aF,marginLeft:aE}).slideDown(600,function(){K.fadeIn(400).find("audio,video").mediaelementplayer({audioWidth:aC,videoWidth:aC,videoHeight:aG,hideVolumeOnTouchDevices:false,startVolume:j&&aj?aj:1,loop:i,enablePseudoStreaming:true,success:function(aJ,aK){ai=aJ;if(a){IE7.recalc()}if(g){aJ.play()}}})})}ah.click(function(){var aC=d.data(am[0],"mode"),aB=aC==="coverflow"?af:aq;if(aB-1<0){return}K.hide().children().not("div.details").remove();am.hide();if(k&&ai){ai.pause();ai=""}if(aC==="coverflow"){ae.slider("value",af-1);Y(af-1);l.find("li").eq(af).trigger("click")}else{n.find("img.thumb").eq(aq-1).trigger("click")}});ar.click(function(){var aC=d.data(am[0],"mode"),aB=aC==="coverflow"?af:aq;if(aB+1===C){return}K.hide().children().not("div.details").remove();am.hide();if(k&&ai){ai.pause();ai=""}if(aC==="coverflow"){ae.slider("value",af+1);Y(af+1);l.find("li").eq(af).trigger("click")}else{n.find("img.thumb").eq(aq+1).trigger("click")}});S.click(function(){K.fadeOut(400,function(){am.slideUp(600,function(){if(ai){aj=ai.volume;if(k){ai.pause();ai=""}}K.children().not("div.details").remove();r.fadeOut(400)})})});function J(aC){var aF=ac.width()-120,aD=ac.height()-220,aE=aF/aD,aB=aC.width/aC.height;if(aC.width>aF||aC.height>aD){if(aB===aE){aC.width=aF;aC.height=aD}else{aC.width=aD*aB;aC.height=aD;if(aC.width>aF){aC.width=aF;aC.height=aF/aB}}}}}});function getRGB(c){var e,d,a;if(c.indexOf("#")===0){if(c.length===4){e=c.substring(1,4).substring(0,1);e=parseInt(e+e,16);d=c.substring(1,4).substring(1,2);d=parseInt(d+d,16);a=c.substring(1,4).substring(2,3);a=parseInt(a+a,16)}else{e=parseInt(c.substring(1,7).substring(0,2),16);d=parseInt(c.substring(1,7).substring(2,4),16);a=parseInt(c.substring(1,7).substring(4,6),16)}}else{if(c.indexOf("rgb")===0){e=c.split("(")[1].split(",")[0];d=c.split("(")[1].split(",")[1];a=c.split("(")[1].split(",")[2].split(")")[0]}else{e="0";d="0";a="0"}}return{r:e,g:d,b:a}}function Plane(b,h,c,i,d,j,f,g){this.width=b;this.height=h;this.focalLength=c;this.ctx=i;this.color=d;this.rotation={x:0,y:0,z:0,parent:this};this.position={x:0,y:0,z:0};this.canvas=this.ctx.canvas;this.cWidth=this.canvas.width;this.cHeight=this.canvas.height;this.centerx=this.cWidth/2;this.centery=this.cHeight/2;this.maxX=0;this.minX=0;this.maxY=0;this.minY=0;this.maxwidth=0;this.maxheight=0;this.maxoffset=0;this.vertexPoints=[make3DPoint(-this.width/2,this.height/2,0),make3DPoint(this.width/2,this.height/2,0),make3DPoint(this.width/2,-this.height/2,0),make3DPoint(-this.width/2,-this.height/2,0)];this.offctx=document.createElement("canvas").getContext("2d");this.offctx.canvas.width=this.width;this.offctx.canvas.height=this.height;this.offctx.drawImage(f,0,0,f.width,f.height,0,0,f.width,f.height);if(!g){this.offctx.scale(1,-1);this.offctx.translate(0,-f.height);this.offctx.drawImage(f,0,0,f.width,f.height,0,-f.height,f.width,f.height);this.offctx.scale(1,-1);var e=0.5*f.height,a=this.offctx.createLinearGradient(0,0,0,e);a.addColorStop(0,"rgba("+j.r+","+j.g+","+j.b+", 0.5)");a.addColorStop(1,"rgba("+j.r+","+j.g+","+j.b+", 1.0)");this.offctx.fillStyle=a;this.offctx.rect(0,0,f.width,e);this.offctx.fill()}}Plane.prototype.render=function(){var e=Transform3DTo2D(this.vertexPoints,this.rotation,this.position,this.focalLength,this.centerx,this.centery),f=document.createElement("canvas").getContext("2d");f.canvas.width=this.width;f.canvas.height=this.height;this.ctx.clearRect(this.minX,this.minY,this.maxwidth,this.maxheight);var c=[e[0],e[1],e[3],e[2]];mapTexture(f,c,this.offctx.canvas);this.ctx.drawImage(f.canvas,0,0);var b=Math.max,d=Math.min,a=Math.abs;this.maxX=(b(e[0].x,e[1].x,e[2].x,e[3].x)+1)|0;this.minX=d(e[0].x,e[1].x,e[2].x,e[3].x)|0;this.maxY=(b(e[0].y,e[1].y,e[2].y,e[3].y)+1)|0;this.minY=d(e[0].y,e[1].y,e[2].y,e[3].y)|0;this.maxwidth=this.maxX-this.minX;this.maxheight=this.maxY-this.minY;this.maxoffset=((a((e[0].x-0)-(this.cWidth-e[1].x)))+0.5)|0};function make3DPoint(a,c,b){return{x:a,y:c,z:b}}function make2DPoint(a,b){return{x:a,y:b}}function Transform3DTo2D(w,j,D,h,u,t){var k=[],A=Math.sin,a=Math.cos,r=A(j.x),e=a(j.x),p=A(j.y),d=a(j.y),o=A(j.z),b=a(j.z),n,m,l,g,f,s,q,C,B,c;var v=w.length;while(v--){n=w[v].x;m=w[v].y;l=w[v].z;g=e*m-r*l;f=r*m+e*l;q=d*f+p*n;s=-p*f+d*n;C=b*s-o*g;B=o*s+b*g;n=C+D.x;m=B+D.y;l=q+D.z;c=h/(h+l);n=n*c+u;m=-(m*c)+t;k[v]={x:n,y:m}}return k};




/*
 * Projective texturing using Canvas.
 * (c) Steven Wittens 2008
 * http://www.acko.net/
 */

/*
 * Modified by Nilok Bose, (c) 2012
 * http://codecanyon.net/user/cosmocoder
 */

function mapTexture(j,i,e){var h=5,g=28,b=getProjectiveTransform(i);var d=b.transformProjectiveVector([0,0,1]),a=b.transformProjectiveVector([1,0,1]),f=b.transformProjectiveVector([0,1,1]),c=b.transformProjectiveVector([1,1,1]);j.save();j.beginPath();j.moveTo(d[0],d[1]);j.lineTo(a[0],a[1]);j.lineTo(c[0],c[1]);j.lineTo(f[0],f[1]);j.closePath();j.clip();divide(0,0,1,1,d,a,f,c,b,h,g,j,e);j.restore()}function divide(o,W,m,V,U,T,S,Q,x,u,l,s,h){var C=Math.abs,B=Math.max,g=Math.min,q=Math.sqrt;if(u){var M=[T[0]+S[0]-2*U[0],T[1]+S[1]-2*U[1]],K=[T[0]+S[0]-2*Q[0],T[1]+S[1]-2*Q[1]],I=[M[0]+K[0],M[1]+K[1]],E=C((I[0]*I[0]+I[1]*I[1])/(M[0]*K[0]+M[1]*K[1]));M=[T[0]-U[0]+Q[0]-S[0],T[1]-U[1]+Q[1]-S[1]];K=[S[0]-U[0]+Q[0]-T[0],S[1]-U[1]+Q[1]-T[1]];var A=C(M[0]*K[1]-M[1]*K[0]);if((o===0&&m===1)||((0.25+E*5)*A>(l*l))){var c=(o+m)/2,w=(W+V)/2,a=x.transformProjectiveVector([c,w,1]),i=x.transformProjectiveVector([c,W,1]),t=x.transformProjectiveVector([c,V,1]),p=x.transformProjectiveVector([o,w,1]),j=x.transformProjectiveVector([m,w,1]);--u;divide(o,W,c,w,U,i,p,a,x,u,l,s,h);divide(c,W,m,w,i,T,a,j,x,u,l,s,h);divide(o,w,c,V,p,a,S,t,x,u,l,s,h);divide(c,w,m,V,a,j,t,Q,x,u,l,s,h);return}}s.save();s.beginPath();s.moveTo(U[0],U[1]);s.lineTo(T[0],T[1]);s.lineTo(Q[0],Q[1]);s.lineTo(S[0],S[1]);s.closePath();var P=[T[0]-U[0],T[1]-U[1]],y=[Q[0]-T[0],Q[1]-T[1]],R=[S[0]-Q[0],S[1]-Q[1]],k=[U[0]-S[0],U[1]-S[1]];var H=C(P[0]*k[1]-P[1]*k[0]),G=C(y[0]*P[1]-y[1]*P[0]),D=C(R[0]*y[1]-R[1]*y[0]),F=C(k[0]*R[1]-k[1]*R[0]),n=B(B(H,G),B(F,D)),d=0,b=0,L=0,J=0;switch(n){case H:s.transform(P[0],P[1],-k[0],-k[1],U[0],U[1]);if(m!==1){L=1.05/q(P[0]*P[0]+P[1]*P[1])}if(V!==1){J=1.05/q(k[0]*k[0]+k[1]*k[1])}break;case G:s.transform(P[0],P[1],y[0],y[1],T[0],T[1]);if(m!==1){L=1.05/q(P[0]*P[0]+P[1]*P[1])}if(V!==1){J=1.05/q(y[0]*y[0]+y[1]*y[1])}d=-1;break;case D:s.transform(-R[0],-R[1],y[0],y[1],Q[0],Q[1]);if(m!==1){L=1.05/q(R[0]*R[0]+R[1]*R[1])}if(V!==1){J=1.05/q(y[0]*y[0]+y[1]*y[1])}d=-1;b=-1;break;case F:s.transform(-R[0],-R[1],-k[0],-k[1],S[0],S[1]);if(m!==1){L=1.05/q(R[0]*R[0]+R[1]*R[1])}if(V!==1){J=1.05/q(k[0]*k[0]+k[1]*k[1])}b=-1;break}var f=(m-o),e=(V-W),O=L*f,N=J*e;var v=h.width,z=h.height;s.drawImage(h,o*v,W*z,g(m-o+O,1)*v,g(V-W+N,1)*z,d,b,1+L,1+J);s.restore()}function getProjectiveTransform(b){var c=new Matrix(9,8,[[1,1,1,0,0,0,-b[3].x,-b[3].x,-b[3].x],[0,1,1,0,0,0,0,-b[2].x,-b[2].x],[1,0,1,0,0,0,-b[1].x,0,-b[1].x],[0,0,1,0,0,0,0,0,-b[0].x],[0,0,0,-1,-1,-1,b[3].y,b[3].y,b[3].y],[0,0,0,0,-1,-1,0,b[2].y,b[2].y],[0,0,0,-1,0,-1,b[1].y,0,b[1].y],[0,0,0,0,0,-1,0,0,b[0].y]]);var d=c.rowEchelon().values;var a=new Matrix(3,3,[[-d[0][8],-d[1][8],-d[2][8]],[-d[3][8],-d[4][8],-d[5][8]],[-d[6][8],-d[7][8],1]]);return a};


/*
 * Generic matrix class.
 * (c) Steven Wittens 2008
 * http://www.acko.net/
 */

/*
 * Modified by Nilok Bose, (c) 2012
 * http://codecanyon.net/user/cosmocoder
 */

var Matrix=function(a,c,b){this.w=a;this.h=c;this.values=b||Matrix.allocate(c)};Matrix.allocate=function(a,e){var b=[],d=e,c=a;while(d--){b[d]=[];while(c--){b[d][c]=0}}return b};Matrix.cloneValues=function(b){clone=[];for(var c=0,a=b.length;c<a;++c){clone[c]=[].concat(b[c])}return clone};Matrix.prototype.transformProjectiveVector=function(b){var c=[];for(var e=0;e<this.h;++e){c[e]=0;for(var a=0;a<this.w;++a){c[e]+=this.values[e][a]*b[a]}}var d=1/(c[c.length-1]);for(var e=0;e<this.h;++e){c[e]*=d}return c};Matrix.prototype.rowEchelon=function(){if(this.w<=this.h){throw"Matrix rowEchelon size mismatch"}var h=Matrix.cloneValues(this.values);for(var a=0;a<this.h;++a){var f=h[a][a];while(f==0){for(var g=a+1;g<this.h;++g){if(h[g][a]!=0){var i=h[g];h[g]=h[a];h[a]=i;break}}if(g==this.h){return new Matrix(this.w,this.h,h)}else{f=h[a][a]}}var b=1/f;for(var e=a;e<this.w;++e){h[a][e]*=b}for(var d=0;d<this.h;++d){if(d==a){continue}var c=h[d][a];h[d][a]=0;for(var e=a+1;e<this.w;++e){h[d][e]-=c*h[a][e]}}}return new Matrix(this.w,this.h,h)};